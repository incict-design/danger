<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</title>
    <style>
        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 600px;
            width: 100%;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            font-family: Arial, sans-serif;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨èªè¨¼ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #report-form, #auth-modal, #auth-status {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #auth-modal {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        
    <h2>ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</h2>    

        <div id="auth-status">
            <p id="user-display">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
            <button id="auth-button" onclick="showAuthModal()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="signout-button" onclick="signOutUser()" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="auth-modal" style="display:none;">
            <h3>ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <p>ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã®ã¯ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã§ã™ã€‚</p>

            <label for="auth-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label><br>
            <input type="email" id="auth-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin-bottom: 10px; width: 90%;"><br>

            <label for="auth-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label><br>
            <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin-bottom: 20px; width: 90%;"><br>

            <button onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="document.getElementById('auth-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            <p id="auth-message" style="color: red; margin-top: 10px;"></p>
        </div>

        <div id="report-form" style="display:none;">
           
            
            <label for="report-datetime">æ—¥æ™‚:</label><br>
            <input type="datetime-local" id="report-datetime" style="margin-bottom: 10px; width: 90%;"><br>
            
            <label for="description">çŠ¶æ³ã®è©³ç´°:</label><br>
            <textarea id="description" rows="3" cols="50" style="width: 90%;"></textarea><br><br>

            <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 

    <script>
        // ----------------------------------------------------
        // 1. Firebaseè¨­å®š: ã‚ãªãŸã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8", // ğŸš¨ ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®apiKey
            authDomain: "danger-e17d4.firebaseapp.com",
            projectId: "danger-e17d4",
            storageBucket: "danger-e17d4.firebasestorage.app",
            messagingSenderId: "671800740218",
            appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
        };

        // Firebaseã®åˆæœŸåŒ–ã¨å‚ç…§ã®å–å¾—
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 
        
        const markers = {}; 
        const reportsData = {}; 
        let currentUser = null; 

        // ----------------------------------------------------
        // 2. Google Maps APIã‚­ãƒ¼ã®è¨­å®šã¨èª­ã¿è¾¼ã¿
        // ----------------------------------------------------
        let map;
        let selectedLocation = null; 

        /**
         * Google Mapã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•° (callbackã§å‘¼ã³å‡ºã•ã‚Œã‚‹)
         */
        function initMap() {
            const initialPos = { lat: 36.3658, lng: 140.4764 }; // ä¾‹: æ°´æˆ¸å¸‚
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialPos,
                zoom: 16,
            });

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (æŠ•ç¨¿ä½ç½®ã®é¸æŠ)
            map.addListener("click", (mapsMouseEvent) => {
                if (!currentUser || !currentUser.emailVerified) {
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†ã—ãªã„ã¨ã€æŠ•ç¨¿ä½ç½®ã‚’é¸æŠã§ãã¾ã›ã‚“ã€‚");
                    return;
                }
                
                const lat = mapsMouseEvent.latLng.lat();
                const lng = mapsMouseEvent.latLng.lng();
                
                selectedLocation = { lat: lat, lng: lng };
                
                document.getElementById('report-datetime').value = '';
                document.getElementById('description').value = ''; 
                
                // ä»¥å‰ã®é¸æŠãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (markers.temp) {
                    markers.temp.setMap(null);
                    delete markers.temp;
                }

                // æ–°ã—ã„é¸æŠãƒãƒ¼ã‚«ãƒ¼ (temp) ã‚’è¿½åŠ 
                markers.temp = new google.maps.Marker({
                    position: selectedLocation,
                    map: map,
                    title: "æŠ•ç¨¿ä½ç½®",
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' // é’è‰²ãƒ”ãƒ³
                });
                
                markers.temp.addListener('rightclick', () => {
                    if (window.confirm("ã“ã®æŠ•ç¨¿ä½ç½®ã®é¸æŠã‚’è§£é™¤ï¼ˆé’ã„ãƒ”ãƒ³ã‚’å‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                        markers.temp.setMap(null);
                        delete markers.temp;
                        selectedLocation = null;
                        document.getElementById('report-datetime').value = '';
                        document.getElementById('description').value = '';
                        alert("æŠ•ç¨¿ä½ç½®ã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
                    }
                });

                document.getElementById('report-form').style.display = 'block';
            });

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢å­˜ã®ãƒ”ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€
            listenForReports();
        }

        /**
         * Firestoreã‹ã‚‰æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
         */
        function listenForReports() {
            db.collection("reports").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();
                    
                    reportsData[docId] = data; 

                    if (change.type === "added") {
                        if (docId === 'temp') return; 
                        
                        const reportMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(data.latitude, data.longitude),
                            map: map,
                            title: data.description,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' // èµ¤ã„ãƒ”ãƒ³
                        });
                        
                        const reportedTime = data.reportTimestamp ? new Date(data.reportTimestamp.toDate()).toLocaleString() : 'ä¸æ˜';

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h3>å±é™ºç®‡æ‰€æƒ…å ±</h3>
                                    <p><strong>æ—¥æ™‚: ${reportedTime}</strong></p> 
                                    <p>${data.description}</p>
                                    <p>æŠ•ç¨¿è€…: <strong>${data.username || 'åŒ¿å'}</strong></p>`
                        });

                        reportMarker.addListener("click", () => {
                            infoWindow.open(map, reportMarker);
                            
                            document.getElementById('report-datetime').value = ''; 
                            document.getElementById('description').value = data.description; 
                            
                            if (markers.temp) {
                                markers.temp.setMap(null);
                                delete markers.temp;
                            }
                            selectedLocation = null;
                        });

                        markers[docId] = reportMarker;

                    } else if (change.type === "removed") {
                        if (markers[docId]) {
                            markers[docId].setMap(null);
                            delete markers[docId];
                            delete reportsData[docId]; 
                        }
                    } 
                });
            });
        }

        // ----------------------------------------------------
        // 3. èªè¨¼æ©Ÿèƒ½ (Auth)
        // ----------------------------------------------------

        /**
         * èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'block';
            document.getElementById('auth-message').innerText = ''; 
            document.getElementById('auth-password').value = ''; 
        }

        /**
         * ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹é–¢æ•°
         */
        async function signIn() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const message = document.getElementById('auth-message');
            message.innerText = '';

            if (!email || !password) {
                message.innerText = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                
                document.getElementById('auth-modal').style.display = 'none';
                
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ", error);
                message.style.color = 'red';
                message.innerText = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
            }
        }

        /**
         * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹é–¢æ•°
         */
        function signOutUser() {
            auth.signOut().then(() => {
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
            }).catch((error) => {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ", error);
            });
        }

        /**
         * èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã€UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            const userDisplay = document.getElementById('user-display');
            const authButton = document.getElementById('auth-button');
            const signoutButton = document.getElementById('signout-button');
            const reportForm = document.getElementById('report-form');
            
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ
                authButton.style.display = 'none';
                signoutButton.style.display = 'inline';

              //  const username = user.displayName || 'ãƒ‹ã‚²ã‚«ãƒ';
                
                if (user.emailVerified) {
                    reportForm.style.display = 'block';
                    userDisplay.innerHTML = `ã‚ˆã†ã“ãã€<strong>${username}</strong> ã•ã‚“ã€‚`;
                } else {
                    reportForm.style.display = 'none';
                    userDisplay.innerHTML = `ã‚ˆã†ã“ãã€<strong>${username}</strong> ã•ã‚“ã€‚âš ï¸æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚`;
                }
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                userDisplay.innerText = 'æŠ•ç¨¿ã§ãã‚‹ã®ã¯ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã§ã™ã€‚ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã£ã¦ã„ãŸã ã‘ã‚‹æ–¹ã¯ç”»é¢å³ä¸Šã®ã€Œæœ¬ã€ãƒãƒ¼ã‚¯ã‹ã‚‰ãŠå•åˆã›ã—ã¦ãã ã•ã„ã€‚';
                authButton.style.display = 'inline';
                signoutButton.style.display = 'none';
                reportForm.style.display = 'none';
                
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ä¸€æ™‚ãƒ”ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (markers.temp) {
                    markers.temp.setMap(null);
                    delete markers.temp;
                }
                selectedLocation = null;
            }
        });

        // ----------------------------------------------------
        // 4. æŠ•ç¨¿æ©Ÿèƒ½
        // ----------------------------------------------------

        /**
         * æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«é€ä¿¡ã™ã‚‹é–¢æ•°
         */
        function submitReport() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!currentUser || !currentUser.emailVerified) {
                alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }

            const reportDatetimeInput = document.getElementById('report-datetime').value;
            const description = document.getElementById('description').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            if (!selectedLocation) {
                alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ”ãƒ³ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!reportDatetimeInput) {
                alert("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!description.trim()) {
                alert("çŠ¶æ³ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reportDate = new Date(reportDatetimeInput);
            const username = currentUser.displayName || 'ãƒ‹ã‚²ã‚«ãƒ'; 

            const reportData = {
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                description: description,
                username: username, // æŠ•ç¨¿è€…å
                reportTimestamp: firebase.firestore.Timestamp.fromDate(reportDate),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("reports").add(reportData)
                .then(() => {
                    alert("æƒ…å ±ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã¨ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('report-datetime').value = '';
                    document.getElementById('description').value = '';
                    if (markers.temp) {
                        markers.temp.setMap(null);
                        delete markers.temp;
                    }
                    selectedLocation = null;
                })
                .catch((error) => {
                    console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ", error);
                    alert("æŠ•ç¨¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                });
        }
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>
</body>
</html>
