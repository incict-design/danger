<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æˆ¸å¸‚ä¸å¯©è€…æƒ…å ±å…±æœ‰ãƒãƒƒãƒ—</title>
    <style>
        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 600px;
            width: 100%;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            font-family: Arial, sans-serif;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨èªè¨¼ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #report-form, #auth-modal, #auth-status {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #auth-modal {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        
     

        <div id="auth-status">
            <p id="user-display">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
            <button id="auth-button" onclick="showAuthModal()">æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="signout-button" onclick="signOutUser()" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="auth-modal" style="display:none;">
            <h3>æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <p>â€»æŠ•ç¨¿ã«ã¯ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå¿…é ˆã§ã™ã€‚</p>
            <label for="auth-username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å (æ–°è¦ç™»éŒ²æ™‚å¿…é ˆ):</label><br>
            <input type="text" id="auth-username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="margin-bottom: 10px; width: 90%;"><br>

            <label for="auth-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label><br>
            <input type="email" id="auth-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin-bottom: 10px; width: 90%;"><br>

            <label for="auth-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label><br>
            <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)" style="margin-bottom: 20px; width: 90%;"><br>

            <button onclick="signUp()">æ–°è¦ç™»éŒ²</button>
            <button onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="document.getElementById('auth-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            <p id="auth-message" style="color: red; margin-top: 10px;"></p>
        </div>

        <div id="report-form" style="display:none;">
           
            
            <label for="report-datetime">æ—¥æ™‚:</label><br>
            <input type="datetime-local" id="report-datetime" style="margin-bottom: 10px; width: 90%;"><br>
            
            <label for="description">çŠ¶æ³ã®è©³ç´°:</label><br>
            <textarea id="description" rows="3" cols="50" style="width: 90%;"></textarea><br><br>

            <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 

    <script>
        // ----------------------------------------------------
        // ğŸš¨ 1. Firebaseè¨­å®š: ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
            authDomain: "danger-e17d4.firebaseapp.com",
            projectId: "danger-e17d4",
            storageBucket: "danger-e17d4.firebasestorage.app",
            messagingSenderId: "671800740218",
            appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
        };

        // Firebaseã®åˆæœŸåŒ–ã¨å‚ç…§ã®å–å¾—
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 
        const usersCollection = db.collection("users"); 

        const markers = {}; 
        const reportsData = {}; 
        let currentUser = null; 

        // ----------------------------------------------------
        // 2. Google Maps APIã‚­ãƒ¼ã®è¨­å®šã¨èª­ã¿è¾¼ã¿
        // ----------------------------------------------------
        let map;
        let selectedLocation = null; 

        /**
         * Google Mapã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         */
        function initMap() {
            const initialPos = { lat: 36.3658, lng: 140.4764 }; // ä¾‹: æ°´æˆ¸å¸‚
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialPos,
                zoom: 16,
            });

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (æŠ•ç¨¿ä½ç½®ã®é¸æŠ)
            map.addListener("click", (mapsMouseEvent) => {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ã¤ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ (æŠ•ç¨¿ã‚’è¨±å¯ã™ã‚‹æ¡ä»¶)
                if (!currentUser || !currentUser.emailVerified) {
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†ã—ãªã„ã¨ã€æŠ•ç¨¿ä½ç½®ã‚’é¸æŠã§ãã¾ã›ã‚“ã€‚");
                    return;
                }
                
                const lat = mapsMouseEvent.latLng.lat();
                const lng = mapsMouseEvent.latLng.lng();
                
                selectedLocation = { lat: lat, lng: lng };
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('report-datetime').value = '';
                document.getElementById('description').value = ''; 
                
                // ä»¥å‰ã®é¸æŠãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (markers.temp) {
                    markers.temp.setMap(null);
                }

                // æ–°ã—ã„é¸æŠãƒãƒ¼ã‚«ãƒ¼ (temp) ã‚’è¿½åŠ 
                markers.temp = new google.maps.Marker({
                    position: selectedLocation,
                    map: map,
                    title: "æŠ•ç¨¿ä½ç½®",
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' // é’è‰²ãƒ”ãƒ³
                });
                
                // é•·æŠ¼ã—(å³ã‚¯ãƒªãƒƒã‚¯)ã§é’ã„ãƒ”ãƒ³ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
                markers.temp.addListener('rightclick', () => {
                    if (window.confirm("ã“ã®æŠ•ç¨¿ä½ç½®ã®é¸æŠã‚’è§£é™¤ï¼ˆé’ã„ãƒ”ãƒ³ã‚’å‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                        markers.temp.setMap(null);
                        delete markers.temp;
                        selectedLocation = null;
                        document.getElementById('report-datetime').value = '';
                        document.getElementById('description').value = '';
                        alert("æŠ•ç¨¿ä½ç½®ã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
                    }
                });
            });

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢å­˜ã®ãƒ”ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€
            listenForReports();
        }

        /**
         * Firestoreã‹ã‚‰æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
         */
        function listenForReports() {
            db.collection("reports").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();
                    
                    reportsData[docId] = data; 

                    if (change.type === "added") {
                        if (docId === 'temp') return; 
                        
                        const reportMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(data.latitude, data.longitude),
                            map: map,
                            title: data.description,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' // èµ¤ã„ãƒ”ãƒ³
                        });
                        
                        // å ±å‘Šæ—¥æ™‚(reportTimestamp)ã‚’å–å¾— (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºä¿®æ­£æ¸ˆã¿)
                        const reportedTime = data.reportTimestamp ? new Date(data.reportTimestamp.toDate()).toLocaleString() : 'ä¸æ˜';

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h3>å±é™ºç®‡æ‰€æƒ…å ±</h3>
                                      <p><strong>æ—¥æ™‚: ${reportedTime}</strong></p> 
                                      <p>${data.description}</p>
                                      <p>æŠ•ç¨¿è€…: <strong>${data.username || 'åŒ¿å'}</strong></p>`
                        });

                        reportMarker.addListener("click", () => {
                            infoWindow.open(map, reportMarker);
                            
                            // æ—¢å­˜ã®ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                            document.getElementById('report-datetime').value = ''; 
                            document.getElementById('description').value = data.description; 
                            
                            if (markers.temp) {
                                markers.temp.setMap(null);
                                delete markers.temp;
                            }
                            selectedLocation = null;
                        });

                        markers[docId] = reportMarker;

                    } else if (change.type === "removed") {
                        if (markers[docId]) {
                            markers[docId].setMap(null);
                            delete markers[docId];
                            delete reportsData[docId]; 
                        }
                    } 
                });
            });
        }

        // ----------------------------------------------------
        // 3. èªè¨¼æ©Ÿèƒ½ (Auth)
        // ----------------------------------------------------

        /**
         * èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'block';
            document.getElementById('auth-message').innerText = ''; 
            document.getElementById('auth-password').value = ''; 
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ–°è¦ç™»éŒ²ã™ã‚‹é–¢æ•° (ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½è¿½åŠ æ¸ˆã¿)
         */
        async function signUp() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const username = document.getElementById('auth-username').value;
            const message = document.getElementById('auth-message');
            message.innerText = '';

            if (!email || !password || !username) {
                message.innerText = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(6æ–‡å­—ä»¥ä¸Š)ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ã™ã¹ã¦å¿…é ˆã§ã™ã€‚';
                return;
            }

            try {
                // 1. Firebase Authã§æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Firestoreã«ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿å­˜ï¼‰
                await usersCollection.doc(user.uid).set({
                    username: username,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 3. ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’é€ä¿¡
                await user.sendEmailVerification();
                
                message.style.color = 'green';
                message.innerText = `ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚${email} ã«èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã®ã§ã€ã”ç¢ºèªãã ã•ã„ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`;
                
                document.getElementById('auth-password').value = '';

                // ç™»éŒ²æˆåŠŸå¾Œã€3ç§’å¾…ã£ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
                setTimeout(() => {
                    window.location.reload(); 
                }, 3000); 

            } catch (error) {
                console.error("æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ", error);
                message.style.color = 'red';
                if (error.code === 'auth/weak-password') {
                    message.innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                } else if (error.code === 'auth/email-already-in-use') {
                    message.innerText = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                } else if (error.code === 'auth/invalid-email') {
                    message.innerText = 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    message.innerText = `æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
                }
            }
        }

        /**
         * ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹é–¢æ•° (æ–°è¦ç™»éŒ²ç›´å¾Œã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿)
         */
        async function signIn() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const message = document.getElementById('auth-message');
            message.innerText = '';

            if (!email || !password) {
                message.innerText = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            try {
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€‚ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®ãƒã‚§ãƒƒã‚¯ã¯onAuthStateChangedã¨æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã§å®Ÿæ–½
                await auth.signInWithEmailAndPassword(email, password);
                
                document.getElementById('auth-modal').style.display = 'none';
                
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ", error);
                message.style.color = 'red';
                message.innerText = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
            }
        }

        /**
         * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹é–¢æ•°
         */
        function signOutUser() {
            auth.signOut().then(() => {
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
            }).catch((error) => {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ", error);
            });
        }

        /**
         * èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã€UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            const userDisplay = document.getElementById('user-display');
            const authButton = document.getElementById('auth-button');
            const signoutButton = document.getElementById('signout-button');
            const reportForm = document.getElementById('report-form');
            
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ (ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãš)
                authButton.style.display = 'none';
                signoutButton.style.display = 'inline';

                if (user.emailVerified) {
                    // ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ã®å ´åˆ
                    reportForm.style.display = 'block';
                    try {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’Firestoreã‹ã‚‰å–å¾—ã—ã€è¡¨ç¤º
                        const userDoc = await usersCollection.doc(user.uid).get();
                        const username = userDoc.exists ? userDoc.data().username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—';
                        userDisplay.innerHTML = `ã‚ˆã†ã“ãã€<strong>${username}</strong> ã•ã‚“ã€‚`;
                    } catch (error) {
                        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                        userDisplay.innerText = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€‚';
                    }
                } else {
                    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã ãŒãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒæœªå®Œäº†ã®å ´åˆ
                    reportForm.style.display = 'none'; // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã¯éè¡¨ç¤ºã®ã¾ã¾
                    userDisplay.innerHTML = `ã‚ˆã†ã“ãã€<strong>${user.email}</strong> ã•ã‚“ã€‚âš ï¸æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†ã—ã¦ã‹ã‚‰ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèªã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
                }
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                userDisplay.innerText = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
                authButton.style.display = 'inline';
                signoutButton.style.display = 'none';
                reportForm.style.display = 'none';
                
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ä¸€æ™‚ãƒ”ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (markers.temp) {
                    markers.temp.setMap(null);
                    delete markers.temp;
                }
                selectedLocation = null;
            }
        });

        // ----------------------------------------------------
        // 4. æŠ•ç¨¿æ©Ÿèƒ½
        // ----------------------------------------------------

        /**
         * æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«é€ä¿¡ã™ã‚‹é–¢æ•°
         */
        function submitReport() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯ (ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹å†ç¢ºèª)
            if (!currentUser || !currentUser.emailVerified) {
                alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ã€ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†ã—ãŸçŠ¶æ…‹ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
                return;
            }

            const reportDatetimeInput = document.getElementById('report-datetime').value;
            const description = document.getElementById('description').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            if (!selectedLocation) {
                alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ”ãƒ³ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!reportDatetimeInput) {
                alert("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!description.trim()) {
                alert("çŠ¶æ³ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // å…¥åŠ›ã•ã‚ŒãŸæ—¥æ™‚ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            const reportDate = new Date(reportDatetimeInput);


            // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã—ã€æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
            usersCollection.doc(currentUser.uid).get().then(userDoc => {
                const username = userDoc.exists ? userDoc.data().username : 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼';

                const reportData = {
                    latitude: selectedLocation.lat,
                    longitude: selectedLocation.lng,
                    description: description,
                    username: username, // æŠ•ç¨¿è€…åã‚’ä¿å­˜
                    reportTimestamp: firebase.firestore.Timestamp.fromDate(reportDate), // å ±å‘Šæ—¥æ™‚ (å…¥åŠ›æ—¥æ™‚)
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // ã‚µãƒ¼ãƒãƒ¼å´ã§æŠ•ç¨¿æ™‚é–“ã‚’è¨˜éŒ²
                };

                db.collection("reports").add(reportData)
                    .then(() => {
                        alert("æƒ…å ±ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ ã¨ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                        document.getElementById('report-datetime').value = '';
                        document.getElementById('description').value = '';
                        if (markers.temp) {
                            markers.temp.setMap(null);
                            delete markers.temp;
                        }
                        selectedLocation = null;
                    })
                    .catch((error) => {
                        console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ", error);
                        alert("æŠ•ç¨¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    });
            }).catch(error => {
                console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æŠ•ç¨¿ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚");
            });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>
</body>
</html>
