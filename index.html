<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Firestore ä¸å¯©è€…æƒ…å ±å…±æœ‰ãƒãƒƒãƒ—</title>
    <style>
        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 600px;
            width: 100%;
            /* â˜…ä¿®æ­£ç®‡æ‰€ 1: ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é˜²æ­¢CSSã®è¿½åŠ  */
            -webkit-user-select: none; /* iOS Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;         /* æ¨™æº– */
            -webkit-tap-highlight-color: transparent; /* ãƒ¢ãƒã‚¤ãƒ«ã®ã‚¿ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
           
            font-family: Arial, sans-serif;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #report-form {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        /* ãƒœã‚¿ãƒ³ã®é…ç½®èª¿æ•´ */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        .form-actions button {
            padding: 8px 10px;
        }
        #reset-pin-button {
            background-color: #f4f4f4;
            color: #333;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
       
        
        <div id="report-form">
           
            
            <label for="description">åœ°å›³ã‚’é•·æŠ¼ã—â†’çŠ¶æ³ã®è©³ç´°:</label><br>
            <textarea id="description" rows="3" cols="50"></textarea><br><br>
            
            <div class="form-actions">
                <button id="reset-pin-button" onclick="resetTemporaryPin()">ãƒ”ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <script>
        // ----------------------------------------------------
        // ğŸš¨ 1. Firebaseè¨­å®š: ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
            authDomain: "danger-e17d4.firebaseapp.com",
            projectId: "danger-e17d4",
            storageBucket: "danger-e17d4.firebasestorage.app",
            messagingSenderId: "671800740218",
            appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
        };

        // Firebaseã®åˆæœŸåŒ–ã¨Firestoreã®å‚ç…§å–å¾—
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Firestoreã‚’å‚ç…§
        const markers = {};
        const reportsData = {}; 
        let currentInfoWindow = null;

        // ----------------------------------------------------
        // 2. Google Maps APIã‚­ãƒ¼ã®è¨­å®šã¨èª­ã¿è¾¼ã¿
        // ----------------------------------------------------
        let map;
        let selectedLocation = null;
        
        // é•·æŠ¼ã—ï¼ˆãƒ­ãƒ³ã‚°ãƒ—ãƒ¬ã‚¹ï¼‰åˆ¤å®šç”¨ã®å¤‰æ•°
        let pressTimer;
        const LONGPRESS_DELAY = 1000; 

        /**
         * Google Mapã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         */
        function initMap() {
            const initialPos = { lat: 36.3658, lng: 140.4764 }; // æ°´æˆ¸å¸‚
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialPos,
                zoom: 16, 
            });
            
            // â˜…ä¿®æ­£ç®‡æ‰€ 2: åœ°å›³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã‚’ç„¡åŠ¹åŒ–
            map.addListener('rightclick', (e) => {
                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã§é•·æŠ¼ã—ãŒå³ã‚¯ãƒªãƒƒã‚¯ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã®ã‚’é˜²ã
                e.stop(); 
            });

            // åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
            map.addListener("click", () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
            });

            // ãƒãƒƒãƒ—ã®é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            const mapElement = document.getElementById("map");
            
            // åœ°å›³è¦ç´ ã«å¯¾ã—ã¦ã€é•·æŠ¼ã—ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºã‚’æŠ‘åˆ¶
            mapElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            // é•·æŠ¼ã—é–‹å§‹ (ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³/ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆ)
            const handlePressStart = (mapsMouseEvent) => {
                pressTimer = setTimeout(() => {
                    handleLongPress(mapsMouseEvent);
                }, LONGPRESS_DELAY);
            };

            // é•·æŠ¼ã—çµ‚äº† (ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—/ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰/ç§»å‹•)
            const handlePressEnd = () => {
                clearTimeout(pressTimer);
            };

            // é•·æŠ¼ã—ãŒç¢ºå®šã—ãŸã¨ãã®å‡¦ç†
            const handleLongPress = (mapsMouseEvent) => {
                const lat = mapsMouseEvent.latLng.lat();
                const lng = mapsMouseEvent.latLng.lng();
                
                selectedLocation = { lat: lat, lng: lng };

                document.getElementById('description').value = ''; 
                
                if (markers.temp) {
                    markers.temp.setMap(null);
                }

                markers.temp = new google.maps.Marker({
                    position: selectedLocation,
                    map: map,
                    title: "æŠ•ç¨¿ä½ç½®",
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                });
                
                markers.temp.addListener("click", () => {
                    const currentDescription = document.getElementById('description').value;

                    const tempInfoWindowContent = `
                        <h3>æ–°è¦æŠ•ç¨¿ä½ç½® (æœªä¿å­˜)</h3>
                        <p><strong>çŠ¶æ³:</strong> ${currentDescription || 'æœªå…¥åŠ›'}</p>
                        <p>è©³ç´°ã‚’å…¥åŠ›ã—ã¦æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                        <p>ã“ã®ãƒ”ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã«ã¯ã€Œãƒ”ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                    `;
                    
                    const tempInfoWindow = new google.maps.InfoWindow({
                        content: tempInfoWindowContent
                    });

                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    
                    tempInfoWindow.open(map, markers.temp);
                    currentInfoWindow = tempInfoWindow;
                });
                
                google.maps.event.trigger(markers.temp, 'click');
            };

            // ãƒãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            map.addListener('mousedown', handlePressStart);
            map.addListener('mouseup', handlePressEnd);
            map.addListener('mousemove', handlePressEnd);

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢å­˜ã®ãƒ”ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€
            listenForReports();
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function attachInfoWindow(marker, data) {
            const infoWindowContent = `
                <h3>ä¸å¯©è€…æƒ…å ±</h3>
                <p><strong>çŠ¶æ³:</strong> ${data.description}</p>
                <p><strong>æ—¥æ™‚:</strong> ${new Date(data.timestamp.toDate()).toLocaleString()}</p>
            `;
            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent
            });

            marker.addListener("click", () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }

                infoWindow.open(map, marker);
                currentInfoWindow = infoWindow;
                
                document.getElementById('description').value = ''; 
                
                if (markers.temp) {
                    markers.temp.setMap(null);
                }
                selectedLocation = null; 
            });
        }

        // Firestoreã‹ã‚‰æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
        function listenForReports() {
            db.collection("reports").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();
                    
                    reportsData[docId] = data; 

                    if (change.type === "added") {
                        if (docId === 'temp') return; 
                        
                        const reportMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(data.latitude, data.longitude),
                            map: map,
                            title: data.description,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        });
                        
                        attachInfoWindow(reportMarker, data);

                        markers[docId] = reportMarker;

                    } else if (change.type === "removed") {
                        if (markers[docId]) {
                            markers[docId].setMap(null);
                            delete markers[docId];
                            delete reportsData[docId]; 
                        }
                    } 
                });
            });
        }

        // ä¸€æ™‚çš„ãªæŠ•ç¨¿ãƒ”ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetTemporaryPin() {
            clearTimeout(pressTimer); 
            
            if (markers.temp) {
                markers.temp.setMap(null);
                delete markers.temp;
                selectedLocation = null;
            }
            
            document.getElementById('description').value = '';

            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }

            alert("æŠ•ç¨¿ãƒ”ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
        }


        // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«é€ä¿¡ã™ã‚‹é–¢æ•°
        function submitReport() {
            const description = document.getElementById('description').value;
            
            if (!selectedLocation) {
                alert("åœ°å›³ã‚’1ç§’é–“é•·æŠ¼ã—ã—ã¦ãƒ”ãƒ³ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!description.trim()) {
                alert("çŠ¶æ³ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reportData = {
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("reports").add(reportData)
                .then(() => {
                    alert("æƒ…å ±ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
                    location.reload(); 
                })
                .catch((error) => {
                    console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ", error);
                    alert("æŠ•ç¨¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>
</body>
</html>
