<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æˆ¸å¸‚ä¸å¯©è€…æƒ…å ±å…±æœ‰ãƒãƒƒãƒ—</title>
    <style>
        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 600px;
            width: 100%;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
           
            font-family: Arial, sans-serif;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #report-form {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>æ°´æˆ¸å¸‚ä¸å¯©è€…æƒ…å ±å…±æœ‰ãƒãƒƒãƒ—</h2>
        
        <div id="report-form">
           
            <label for="description">çŠ¶æ³ã®è©³ç´°:</label><br>
            <textarea id="description" rows="3" cols="50"></textarea><br><br>
            
            <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <script>
        // ----------------------------------------------------
        // ğŸš¨ 1. Firebaseè¨­å®š: ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
            authDomain: "danger-e17d4.firebaseapp.com",
            projectId: "danger-e17d4",
            storageBucket: "danger-e17d4.firebasestorage.app",
            messagingSenderId: "671800740218",
            appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
        };

        // Firebaseã®åˆæœŸåŒ–ã¨Firestoreã®å‚ç…§å–å¾—
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Firestoreã‚’å‚ç…§
        const markers = {}; // ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã§ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const reportsData = {}; 

        // ----------------------------------------------------
        // 2. Google Maps APIã‚­ãƒ¼ã®è¨­å®šã¨èª­ã¿è¾¼ã¿
        // ----------------------------------------------------
        let map;
        let selectedLocation = null; // é¸æŠã•ã‚ŒãŸæŠ•ç¨¿ä½ç½®ã®åº§æ¨™ã‚’ä¿æŒ

        /**
         * Google Mapã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         */
        function initMap() {
            const initialPos = { lat: 36.3658, lng: 140.4764 }; // ä¾‹: æ°´æˆ¸å¸‚
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialPos,
                zoom: 16,
            });

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (æŠ•ç¨¿ä½ç½®ã®é¸æŠ)
            map.addListener("click", (mapsMouseEvent) => {
                const lat = mapsMouseEvent.latLng.lat();
                const lng = mapsMouseEvent.latLng.lng();
                
                // â˜…ä¿®æ­£: ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸåº§æ¨™ã‚’selectedLocationã«ç›´æ¥ä¿å­˜ã™ã‚‹
                selectedLocation = { lat: lat, lng: lng };

                // åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã¯ã€è©³ç´°å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
                document.getElementById('description').value = ''; 
                
                // ä»¥å‰ã®é¸æŠãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (markers.temp) {
                    markers.temp.setMap(null);
                }

                // æ–°ã—ã„é¸æŠãƒãƒ¼ã‚«ãƒ¼ (temp) ã‚’è¿½åŠ 
                markers.temp = new google.maps.Marker({
                    position: selectedLocation,
                    map: map,
                    title: "æŠ•ç¨¿ä½ç½®",
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                });
            });

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢å­˜ã®ãƒ”ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€
            listenForReports();
        }

        /**
         * Firestoreã‹ã‚‰æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
         */
        function listenForReports() {
            db.collection("reports").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();
                    
                    reportsData[docId] = data; 

                    if (change.type === "added") {
                        if (docId === 'temp') return; 
                        
                        const reportMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(data.latitude, data.longitude),
                            map: map,
                            title: data.description,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h3>ä¸å¯©è€…æƒ…å ±</h3><p>${data.description}</p><p>æ—¥æ™‚: ${new Date(data.timestamp.toDate()).toLocaleString()}</p>`
                        });

                        reportMarker.addListener("click", () => {
                            // 1. æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
                            infoWindow.open(map, reportMarker);
                            
                            // 2. ãƒ•ã‚©ãƒ¼ãƒ ã«æƒ…å ±ã‚’è¡¨ç¤º
                            // â˜…ä¿®æ­£: ç·¯åº¦çµŒåº¦ã®å…¥åŠ›æ¬„ãŒãªã„ãŸã‚ã€descriptionã®ã¿è¡¨ç¤ºã™ã‚‹
                            document.getElementById('description').value = data.description; 
                            
                            // 3. ä¸€æ™‚æŠ•ç¨¿ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã€æŠ•ç¨¿ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                            if (markers.temp) {
                                markers.temp.setMap(null);
                                delete markers.temp;
                            }
                            selectedLocation = null; // æ—¢å­˜ãƒ”ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯æ–°è¦æŠ•ç¨¿ã§ã¯ãªã„ãŸã‚ãƒªã‚»ãƒƒãƒˆ
                        });

                        markers[docId] = reportMarker;

                    } else if (change.type === "removed") {
                        if (markers[docId]) {
                            markers[docId].setMap(null);
                            delete markers[docId];
                            delete reportsData[docId]; 
                        }
                    } 
                });
            });
        }


        /**
         * æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«é€ä¿¡ã™ã‚‹é–¢æ•°
         */
        function submitReport() {
            const description = document.getElementById('description').value;
            
            // â˜…ä¿®æ­£: selectedLocationãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ï¼ˆåœ°å›³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ï¼‰å ´åˆã¯è­¦å‘Š
            if (!selectedLocation) {
                alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ”ãƒ³ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!description.trim()) {
                alert("çŠ¶æ³ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reportData = {
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("reports").add(reportData)
                .then(() => {
                    alert("æƒ…å ±ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã¨ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('description').value = '';
                    if (markers.temp) {
                        markers.temp.setMap(null);
                        delete markers.temp;
                    }
                    selectedLocation = null;
                })
                .catch((error) => {
                    console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ", error);
                    alert("æŠ•ç¨¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>
</body>
</html>
