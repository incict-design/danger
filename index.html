<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水戸市不審者情報共有マップ</title>
    <style>
        #map { height: 600px; width: 100%; }
        .container { max-width: 800px; margin: 20px auto; font-family: Arial, sans-serif; }
        #report-form, #auth-modal, #auth-status {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #auth-modal { background-color: #f9f9f9; }
    </style>
</head>
<body>
<div class="container">

    <div id="auth-status">
        <p id="user-display">ログインしていません。</p>
        <button id="auth-button" onclick="showAuthModal()">新規登録 / ログイン</button>
        <button id="signout-button" onclick="signOutUser()" style="display:none;">ログアウト</button>
    </div>

    <div id="auth-modal" style="display:none;">
        <h3>新規登録 / ログイン</h3>
        <p>※投稿にはメール認証が必須です。</p>
        <label>ユーザー名:</label><br>
        <input type="text" id="auth-username" style="margin-bottom: 10px; width: 90%;"><br>
        <label>メールアドレス:</label><br>
        <input type="email" id="auth-email" style="margin-bottom: 10px; width: 90%;"><br>
        <label>パスワード:</label><br>
        <input type="password" id="auth-password" style="margin-bottom: 20px; width: 90%;"><br>
        <button onclick="signUp()">新規登録</button>
        <button onclick="signIn()">ログイン</button>
        <button onclick="document.getElementById('auth-modal').style.display='none'">閉じる</button>
        <p id="auth-message" style="color:red; margin-top:10px;"></p>
    </div>

    <div id="report-form" style="display:none;">
        <label>日時:</label><br>
        <input type="datetime-local" id="report-datetime" style="width: 90%; margin-bottom:10px;"><br>

        <label>状況の詳細:</label><br>
        <textarea id="description" rows="3" style="width: 90%;"></textarea><br><br>

        <button onclick="submitReport()">投稿する</button>
    </div>

    <div id="map"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
/* Firebase 設定 */
const firebaseConfig = {
    apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
    authDomain: "danger-e17d4.firebaseapp.com",
    projectId: "danger-e17d4",
    storageBucket: "danger-e17d4.firebasestorage.app",
    messagingSenderId: "671800740218",
    appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const usersCollection = db.collection("users");

let map;
const markers = {};
let selectedLocation = null;
let currentUser = null;

/* Google Maps 初期化 */
function initMap() {
    const pos = { lat: 36.3658, lng: 140.4764 };

    map = new google.maps.Map(document.getElementById("map"), {
        center: pos,
        zoom: 16
    });

    map.addListener("click", (e) => {
        if (!currentUser || !currentUser.emailVerified) {
            alert("ログインしてメール認証を完了してください。");
            return;
        }

        selectedLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };

        if (markers.temp) {
            markers.temp.setMap(null);
            delete markers.temp;
        }

        addTempMarker(selectedLocation);
    });

    listenForReports();
}

/* temp マーカー追加（青ピン） */
function addTempMarker(location) {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        title: "投稿位置"
    });

    markers.temp = marker;

    let pressTimer;
    const longPressTime = 800; // 長押し判定時間

    const startPress = () => {
        pressTimer = setTimeout(() => {
            deleteTempMarker();
        }, longPressTime);
    };
    const cancelPress = () => clearTimeout(pressTimer);

    marker.addListener("mousedown", startPress);
    marker.addListener("mouseup", cancelPress);
    marker.addListener("touchstart", startPress);
    marker.addListener("touchend", cancelPress);

    marker.addListener("rightclick", deleteTempMarker);
}

/* tempマーカー削除 */
function deleteTempMarker() {
    if (window.confirm("青いピンを削除しますか？")) {
        if (markers.temp) {
            markers.temp.setMap(null);
            delete markers.temp;
        }
        selectedLocation = null;
        document.getElementById('report-datetime').value = "";
        document.getElementById('description').value = "";
        alert("青いピンを削除しました。");
    }
}

/* Firestore リアルタイム更新 */
function listenForReports() {
    db.collection("reports").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            const id = change.doc.id;
            const data = change.doc.data();

            if (change.type === "added") {
                const marker = new google.maps.Marker({
                    position: new google.maps.LatLng(data.latitude, data.longitude),
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                });

                const info = new google.maps.InfoWindow({
                    content: `
                        <h3>不審者情報</h3>
                        <p><strong>日時:</strong> ${
                            data.reportTimestamp ? new Date(data.reportTimestamp.toDate()).toLocaleString() : "不明"
                        }</p>
                        <p>${data.description}</p>
                        <p>投稿者: <strong>${data.username || "匿名"}</strong></p>
                    `
                });

                marker.addListener("click", () => info.open(map, marker));
                markers[id] = marker;
            }
            if (change.type === "removed") {
                markers[id]?.setMap(null);
                delete markers[id];
            }
        });
    });
}

/* 認証処理 */
function showAuthModal() {
    document.getElementById("auth-modal").style.display = "block";
    document.getElementById("auth-message").innerText = "";
}

async function signUp() {
    const email = authEmail.value;
    const password = authPassword.value;
    const username = authUsername.value;
    const msg = authMessage;

    if (!email || !password || !username) {
        msg.innerText = "すべて入力してください。";
        return;
    }

    try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await usersCollection.doc(cred.user.uid).set({ username, email });
        await cred.user.sendEmailVerification();
        msg.style.color = "green";
        msg.innerText = "認証メールを送信しました。";
    } catch (e) {
        msg.innerText = "登録に失敗しました。";
    }
}

async function signIn() {
    const email = authEmail.value;
    const password = authPassword.value;
    const msg = authMessage;

    try {
        await auth.signInWithEmailAndPassword(email, password);
        document.getElementById("auth-modal").style.display = "none";
    } catch {
        msg.innerText = "ログイン失敗";
    }
}

function signOutUser() {
    auth.signOut();
}

auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    const display = document.getElementById("user-display");
    const form = document.getElementById("report-form");

    if (!user) {
        display.innerText = "ログインしていません。";
        form.style.display = "none";
        return;
    }

    const doc = await usersCollection.doc(user.uid).get();
    const name = doc.exists ? doc.data().username : "ユーザー";

    if (user.emailVerified) {
        display.innerHTML = `ようこそ <strong>${name}</strong> さん`;
        form.style.display = "block";
    } else {
        display.innerHTML = `${user.email} さん。メール認証を済ませてください。`;
        form.style.display = "none";
    }
});

/* 投稿 */
function submitReport() {
    if (!selectedLocation) {
        alert("青いピンを置いてください。");
        return;
    }

    const datetime = reportDatetime.value;
    const desc = description.value.trim();
    if (!datetime || !desc) {
        alert("すべて入力してください。");
        return;
    }

    usersCollection.doc(currentUser.uid).get().then(doc => {
        const username = doc.data().username;
        db.collection("reports").add({
            latitude: selectedLocation.lat,
            longitude: selectedLocation.lng,
            description: desc,
            username,
            reportTimestamp: firebase.firestore.Timestamp.fromDate(new Date(datetime)),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        deleteTempMarker();
        alert("投稿完了しました！");
    });
}
</script>

<!-- ⭐ Google Maps API (あなたのキーに置き換えてください) -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap">
</script>

</body>
</html>
